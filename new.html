<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attendee Contact Card</title>
    <!-- We will use Tailwind CSS for rapid and responsive styling --><script src="https://cdn.tailwindcss.com"></script>
    <!-- Using Roboto font (Google's font) --><link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <style>
        /* Custom styles */
        body {
            /* Use Roboto as the primary font */
            font-family: 'Roboto', -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        /* Custom Google Colors for Tailwind */
        .text-google-blue { color: #4285F4; }
        .text-google-red { color: #EA4335; }
        .hover\:text-google-blue:hover { color: #4285F4; }
        .border-google-gray { border-color: #DADCE0; }
        .hover\:border-google-blue:hover { border-color: #4285F4; }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <div class="bg-white rounded-xl shadow-lg w-full max-w-md overflow-hidden">
        
        <!-- Loading State --><div id="loading" class="p-8 text-center text-gray-600 hidden">
            <!-- Use Google Blue --><i class="fas fa-spinner fa-spin text-3xl text-google-blue"></i>
            <p class="mt-2">Loading attendee data...</p>
        </div>

        <!-- Error State --><div id="error" class="hidden p-8 text-center">
            <!-- Use Google Red --><i class="fas fa-exclamation-triangle text-3xl text-google-red"></i>
            <p class="mt-2 font-semibold text-google-red">Attendee Not Found</p>
            <p class="text-sm text-gray-500">Please check the ID and try again.</p>
        </div>

        <!-- Main Content (Hidden by default) --><div id="cardContent" class="hidden">
            
            <!-- Header Section - Fixed class typo and increased padding --><div class="card-header text-center p-8 bg-gray-50 border-b border-gray-200">
                <!-- Avatar REMOVED --><h1 id="name" class="text-3xl font-bold text-gray-900"></h1>
                <!-- Company Info --><p id="company" class="text-lg text-google-blue font-medium"></p>
                <!-- Specialization --><p id="specialization" class="text-md text-gray-700 mt-2"></p>
                <!-- Experience section MOVED from header --></div>

            <!-- Body Section --><div class="p-6 space-y-6">
                
                <!-- Experience Section (MOVED here) --><div class="card-section">
                    <h2 class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-3">Experience</h2>
                    <div id="experienceContainer" class="flex flex-wrap gap-2">
                        <!-- Experience tags will be injected here --></div>
                </div>

                <!-- Contact Section --><div class="card-section">
                    <h2 class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-3">Contact</h2>
                    <div class="space-y-3">
                        <!-- Email --><a id="emailLink" class="info-item flex items-center group" href="#">
                            <i class="fas fa-envelope w-5 text-center text-gray-400 group-hover:text-google-blue"></i>
                            <span id="email" class="ml-3 text-gray-700 group-hover:text-google-blue break-all"></span>
                        </a>
                        <!-- LinkedIn (dynamically added) --><div id="linkedinContainer"></div>
                    </div>
                </div>

                <!-- Interests Section --><div class="card-section">
                    <h2 class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-3">Interests</h2>
                    <div id="interests" class="flex flex-wrap gap-2">
                        <!-- Tags will be injected here --></div>
                </div>

                <!-- Action Buttons Section --><div class="action-buttons flex flex-col gap-3 pt-4 border-t border-gray-100">
                    <!-- WhatsApp button (hidden by default) - Kept green for branding --><a id="whatsappBtn" class="btn btn-whatsapp hidden w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg flex items-center justify-center transition-colors duration-200" href="#" target="_blank">
                        <i class="fab fa-whatsapp mr-2"></i>
                        Contact on WhatsApp
                    </a>
                    <!-- Download VCF button - Google "outline" button style --><button id="vcfBtn" class="btn btn-csv w-full bg-transparent hover:bg-gray-100 text-google-blue font-bold py-3 px-4 rounded-lg flex items-center justify-center transition-colors duration-200 border border-google-gray hover:border-google-blue">
                        <i class="fas fa-download mr-2"></i>
                        Save Contact (.vcf)
                    </button>
                </div>
            </div>
        </div>

    </div>

    <script>
        // --- MOCK DATABASE REMOVED ---
        
        // --- GOOGLE COLORS ---
        // Arrays for dynamic coloring of tags
        const googleTagColors = [
            { bg: 'bg-blue-100', text: 'text-blue-800' },
            { bg: 'bg-green-100', text: 'text-green-800' },
            { bg: 'bg-yellow-100', text: 'text-yellow-800' },
            { bg: 'bg-red-100', text: 'text-red-800' }
        ];
        // --- END GOOGLE COLORS ---

        // --- LABEL MAPPINGS ---
        // Maps raw values from the form to human-readable labels
        const experienceLabels = {
            "0-1": "< 1 year experience",
            "1-2": "1-2 years experience",
            "3-5": "3-5 years experience",
            "5-7": "5+ years experience",
            "freelancer": "Freelancer",
            "cto_ceo": "CTO / CEO / Executive",
            "manager_teamlead": "Manager / Team Lead",
            "intern": "Intern",
            "bootcamp": "Bootcamp Attendee",
            "student": "University Student",
            "undergrad_student": "1st or 2nd Year Student",
            "post_grad": "3rd Year Student",
            "grad_student": "Master Student / PHD",
            "fresh_grad": "Fresh Graduate"
        };

        const interestLabels = {
            "angular": "Angular",
            "nodejs": "Node.js",
            "golang": "Golang",
            "firebase": "Firebase",
            "web_technologies": "Web Technologies",
            "backend_development": "Backend Development",
            "frontend_development": "Front End Development",
            "cloud": "Cloud",
            "kubernetes": "Kubernetes",
            "microservices": "Microservices",
            "database": "Database",
            "android": "Android",
            "flutter": "Flutter",
            "machine_learning": "Machine learning",
            "tensorflow": "Tensorflow",
            "gemini_chatgpt": "Gemini / ChatGPT",
            "cybersecurity": "Cybersecurity",
            "web3_blockchain": "Web3 / Blockchain",
            "other": "Other"
        };

        const specializationLabels = {
            "ai_engineer": "AI Engineer / Researcher",
            "full_stack": "Full Stack Software Engineer",
            "data_scientist": "Data Scientist / Data Engineer",
            "cloud_architect": "Cloud Architect / DevOps Engineer",
            "backend_developer": "Backend Developer (Node.js, Go, Python..)",
            "frontend_developer": "Frontend Developer (React, Vue, Angular)",
            "mobile_developer": "Mobile Developer (Android, iOS, Flutter)",
            "product_manager": "Project / Product Manager",
            "other_tech": "Other in tech",
            "other_non_tech": "Other non-tech"
        };
        // --- END LABEL MAPPINGS ---


        // Run this script when the webpage content is loaded
        document.addEventListener("DOMContentLoaded", () => {
            // 1. Get references to our HTML elements
            const loadingEl = document.getElementById('loading');
            const errorEl = document.getElementById('error');
            const cardContentEl = document.getElementById('cardContent');

            // 2. Get the 'id' parameter from the URL
            const params = new URLSearchParams(window.location.search);
            const userId = params.get('id');

            // --- TEST MODIFICATION REMOVED ---

            // 3. Check if an ID was provided
            if (!userId) {
                loadingEl.classList.add('hidden');
                errorEl.classList.remove('hidden');
                errorEl.querySelector('p.font-semibold').textContent = "No Attendee ID Provided";
                errorEl.querySelector('p.text-sm').textContent = "Please add an '?id=...' to the URL.";
                return; // Stop execution
            }

            // 4. If ID exists, show loading and fetch data
            loadingEl.classList.remove('hidden');
            const apiUrl = `https://script.google.com/macros/s/AKfycbya3qV3NYY0IUw9y7m4ZFup-hcR_9DbYo6iPciA7rkBwWJ2tXvu0DfDIGOW-xC1A0wp/exec?id=${userId}`;
            
            fetchAttendeeData(apiUrl);
        });

        // New function to fetch and handle API data
        async function fetchAttendeeData(apiUrl) {
            const loadingEl = document.getElementById('loading');
            const errorEl = document.getElementById('error');
            const cardContentEl = document.getElementById('cardContent');

            try {
                const response = await fetch(apiUrl);

                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }

                const result = await response.json();

                if (result.status === "success" && result.data) {
                    const user = result.data;

                    // 5. Populate the card with user data
                    populateCard(user);

                    // 6. Set up event listener for VCF download
                    document.getElementById('vcfBtn').addEventListener('click', () => {
                        downloadAsVCF(user);
                    });

                    // 7. Show content
                    loadingEl.classList.add('hidden');
                    cardContentEl.classList.remove('hidden');

                } else {
                    // Handle API errors (e.g., user not found)
                    throw new Error(result.message || 'Attendee not found');
                }

            } catch (error) {
                // Handle fetch errors (e.g., network down)
                console.error('Fetch error:', error);
                loadingEl.classList.add('hidden');
                errorEl.classList.remove('hidden');
                errorEl.querySelector('p.font-semibold').textContent = "Failed to Load Attendee";
                errorEl.querySelector('p.text-sm').textContent = "The ID might be incorrect or the network is down.";
            }
        }


        function populateCard(user) {
            // Populate header
            document.getElementById('name').textContent = `${user.firstName} ${user.lastName}`;
            
            // Company
            const company = user.company ? user.company : 'No company listed';
            document.getElementById('company').textContent = company;

            // Specialization
            const rawSpecialization = user.specialization || 'N/A';
            const specializationLabel = specializationLabels[rawSpecialization] || rawSpecialization.replace(/_/g, ' ').replace(/^\w/, c => c.toUpperCase());
            document.getElementById('specialization').textContent = `Specialization: ${specializationLabel}`;
            
            // Experience (as tags)
            const experienceContainer = document.getElementById('experienceContainer');
            if (user.experience) {
                // Treat experience as a comma-separated list
                const experiences = user.experience.split(',').map(item => item.trim());
                experiences.forEach((exp, index) => {
                    const tag = document.createElement('span');
                    const color = googleTagColors[(index + 1) % googleTagColors.length];
                    tag.className = `experience-tag ${color.bg} ${color.text} text-xs font-medium px-3 py-1 rounded-full`;
                    
                    // Use the label map, with a fallback to prettify the raw value
                    const label = experienceLabels[exp] || exp.replace(/_/g, ' ').replace(/^\w/, c => c.toUpperCase());
                    tag.textContent = label; 
                    
                    experienceContainer.appendChild(tag);
                });
            } else {
                experienceContainer.innerHTML = `<span class="text-sm text-gray-500">No experience listed.</span>`;
            }

            // Populate contact info
            const emailLink = document.getElementById('emailLink');
            emailLink.href = `mailto:${user.email}`;
            document.getElementById('email').textContent = user.email;

            // Handle LinkedIn (Conditional)
            const linkedinContainer = document.getElementById('linkedinContainer');
            if (user.linkedin && (user.linkedin.startsWith('http') || user.linkedin.startsWith('www'))) {
                // Extract username and clean URL
                let username = 'Profile'; // Default
                let cleanLinkedinHref = user.linkedin;
                try {
                    const linkedinUrl = new URL(user.linkedin.startsWith('http') ? user.linkedin : `https://${user.linkedin}`);
                    let pathParts = linkedinUrl.pathname.split('/').filter(p => p);
                    if (pathParts.length > 1 && pathParts[0] === 'in') {
                        // Get the part after /in/, typically the username segment
                        username = pathParts[1];
                    }
                    // Construct a cleaner URL for the link href
                    cleanLinkedinHref = `https://www.linkedin.com/in/${username}`;
                } catch(e) {
                    console.warn("Could not parse LinkedIn URL:", user.linkedin);
                    // Fallback to username from a simple string split if URL parsing fails
                    const parts = user.linkedin.split('linkedin.com/in/');
                    if (parts.length > 1) {
                        username = parts[1].split('/')[0].split('?')[0];
                        cleanLinkedinHref = `https://www.linkedin.com/in/${username}`;
                    } else {
                        username = "Profile (link)"
                    }
                }

                linkedinContainer.innerHTML = `
                    <a id="linkedinLink" class="info-item flex items-center group" href="${cleanLinkedinHref}" target="_blank" rel="noopener noreferrer">
                        <i class="fab fa-linkedin w-5 text-center text-blue-600 group-hover:text-google-blue"></i>
                        <span class="ml-3 text-gray-700 group-hover:text-google-blue break-all">LinkedIn: ${username}</span>
                    </a>
                `;
            } else if (user.linkedin) {
                // It's text/description, not a link
                linkedinContainer.innerHTML = `
                    <div class="info-item flex items-start">
                        <i class="fas fa-info-circle w-5 text-center text-gray-400 mt-1"></i>
                        <span class="ml-3 text-gray-700"><strong class="font-medium">Bio:</strong> ${user.linkedin}</span>
                    </div>
                `;
            }
            // If user.linkedin is empty, nothing is added.

            // Handle Interests
            const interestsContainer = document.getElementById('interests');
            if (user.interestedIn) {
                const interests = user.interestedIn.split(',').map(item => item.trim());
                // Use index to cycle through Google colors
                interests.forEach((interest, index) => {
                    const tag = document.createElement('span');
                    // Cycle through the color array
                    const color = googleTagColors[index % googleTagColors.length];
                    tag.className = `interest-tag ${color.bg} ${color.text} text-xs font-medium px-3 py-1 rounded-full`;
                    
                    // Use the label map, with a fallback to prettify the raw value
                    const label = interestLabels[interest] || interest.replace(/_/g, ' ').replace(/^\w/, c => c.toUpperCase());
                    tag.textContent = label; // Prettify
                    
                    interestsContainer.appendChild(tag);
                });
            } else {
                interestsContainer.innerHTML = `<span class="text-sm text-gray-500">No interests listed.</span>`;
            }

            // Handle WhatsApp Button (Conditional)
            const whatsappBtn = document.getElementById('whatsappBtn');
            if (user.phone) {
                // Clean the phone number (remove +, spaces, etc. for the URL)
                const whatsappNumber = user.phone.replace(/[\s+()-]/g, '');
                whatsappBtn.href = `https://wa.me/${whatsappNumber}`;
                whatsappBtn.classList.remove('hidden'); // Show the button
            }
        }

        function downloadAsVCF(user) {
            let vcfContent = 'BEGIN:VCARD\n';
            vcfContent += 'VERSION:3.0\n';
            
            // Name
            vcfContent += `N:${user.lastName || ''};${user.firstName || ''};;;\n`;
            vcfContent += `FN:${user.firstName || ''} ${user.lastName || ''}\n`;
            
            // Company
            if (user.company) {
                vcfContent += `ORG:${user.company}\n`;
            }
            
            // Specialization (Title)
            const rawSpecialization = user.specialization || '';
            const specializationLabel = specializationLabels[rawSpecialization] || rawSpecialization.replace(/_/g, ' ').replace(/^\w/, c => c.toUpperCase());
            if (specializationLabel && specializationLabel !== 'N/a') {
                vcfContent += `TITLE:${specializationLabel}\n`;
            }
            
            // Phone
            if (user.phone) {
                vcfContent += `TEL;TYPE=CELL:${user.phone}\n`;
            }
            
            // Email
            if (user.email) {
                vcfContent += `EMAIL:${user.email}\n`;
            }

            // LinkedIn URL
            if (user.linkedin && (user.linkedin.startsWith('http') || user.linkedin.startsWith('www'))) {
                let username = '';
                let cleanLinkedinHref = user.linkedin;
                try {
                    const linkedinUrl = new URL(user.linkedin.startsWith('http') ? user.linkedin : `https://${user.linkedin}`);
                    let pathParts = linkedinUrl.pathname.split('/').filter(p => p);
                    if (pathParts.length > 1 && pathParts[0] === 'in') {
                        username = pathParts[1];
                        cleanLinkedinHref = `https://www.linkedin.com/in/${username}`;
                    }
                } catch(e) {
                    const parts = user.linkedin.split('linkedin.com/in/');
                    if (parts.length > 1) {
                        username = parts[1].split('/')[0].split('?')[0];
                        cleanLinkedinHref = `https://www.linkedin.com/in/${username}`;
                    }
                }
                vcfContent += `URL;TYPE=LinkedIn:${cleanLinkedinHref}\n`;
            }
            
            // Note (Experience and Interests)
            let note = '';
            if (user.experience) {
                const experiences = user.experience.split(',').map(item => item.trim());
                const experienceStrings = experiences.map(exp => experienceLabels[exp] || exp.replace(/_/g, ' ').replace(/^\w/, c => c.toUpperCase()));
                note += `Experience: ${experienceStrings.join(', ')}`;
            }
            
            if (user.interestedIn) {
                if (note !== '') note += '\\n'; // VCF newline escape
                const interests = user.interestedIn.split(',').map(item => item.trim());
                const interestStrings = interests.map(interest => interestLabels[interest] || interest.replace(/_/g, ' ').replace(/^\w/, c => c.toUpperCase()));
                note += `Interests: ${interestStrings.join(', ')}`;
            }
            
            if (note !== '') {
                vcfContent += `NOTE:${note}\n`;
            }
            
            vcfContent += 'END:VCARD\n';
            
            // Create a Blob
            const blob = new Blob([vcfContent], { type: 'text/vcard;charset=utf-8;' });
            
            // Create a temporary link to trigger the download
            const link = document.createElement("a");
            const filename = `${user.firstName || 'contact'}_${user.lastName || ''}.vcf`;

            if (window.navigator.msSaveOrOpenBlob) {
                // For IE
                window.navigator.msSaveOrOpenBlob(blob, filename);
            } else {
                // For modern browsers
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", filename);
                
                // Trigger the download
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            }
        }

    </script>
</body>
</html>

